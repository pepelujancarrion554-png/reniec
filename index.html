<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal - Subir y extraer datos (OCR) - Optimizado</title>
  <style>
    :root{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#111}
    body{display:flex;flex-wrap:wrap;gap:20px;padding:20px;background:#f6f7fb}
    .left,.right{background:#fff;border-radius:10px;padding:16px;box-shadow:0 6px 20px rgba(17,24,39,0.06)}
    .left{flex:1 1 540px;min-width:320px}
    .right{width:360px}
    h1{font-size:18px;margin:0 0 8px}
    p.lead{margin:0 0 12px;color:#555}
    label.file{display:block;border:2px dashed #dbe2f0;padding:14px;border-radius:10px;text-align:center;cursor:pointer}
    .controls{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
    button{padding:8px 12px;border-radius:8px;border:none;background:#2563eb;color:white;cursor:pointer}
    button.secondary{background:#e6eefc;color:#0b3b82}
    .field{margin:8px 0}
    .field b{display:inline-block;width:140px}
    #previewWrap{display:flex;gap:8px;align-items:flex-start}
    #preview{max-width:380px;width:100%;height:auto;border-radius:6px;border:1px solid #ddd}
    canvas{display:none}
    pre.debug{white-space:pre-wrap;background:#111;color:#fff;padding:8px;border-radius:6px;max-height:220px;overflow:auto}
    .status{font-size:13px;color:#444;margin-top:6px}
    .toggles{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:#666}
    footer{margin-top:12px;color:#666;font-size:13px}
  </style>
</head>
<body>
  <div class="left">
    <h1>Sube imagen o PDF (OCR) — Optimizado</h1>
    <p class="lead">Sube una imagen o PDF. Se mostrará el documento y se extraerán campos clave (DNI, titular, fecha de nacimiento, sexo, estado civil, domicilio, fecha caducidad, etc.).</p>

    <input id="file" type="file" accept="image/*,.pdf" style="display:none">
    <label for="file" class="file">Haz clic o arrastra aquí para seleccionar un archivo (imagen / PDF)</label>

    <div class="controls">
      <button id="process">Procesar</button>
      <button id="clear" class="secondary">Limpiar</button>
      <button id="downloadCsv" class="secondary">Descargar CSV</button>
      <div style="flex:1"></div>
      <div class="toggles small">
        <label><input type="checkbox" id="fastMode" checked> Modo rápido</label>
      </div>
    </div>

    <div id="previewWrap">
      <img id="preview" alt="Preview" src="" />
      <div style="flex:1">
        <div class="field"><b>Progreso:</b> <span id="log">—</span></div>
        <div class="field"><b>Worker:</b> <span id="workerStatus">No iniciado</span></div>
        <div style="margin-top:8px">
          <details>
            <summary>Texto OCR (depuración)</summary>
            <pre id="ocrText" class="debug">—</pre>
          </details>
        </div>
      </div>
    </div>

    <canvas id="pageCanvas"></canvas>

    <footer>Nota: este ejemplo intenta equilibrar velocidad y precisión. Para documentos reales usa imágenes limpias y buena iluminación.</footer>
  </div>

  <div class="right">
    <h2>Resultados extraídos</h2>
    <div class="field"><b>DNI nº:</b> <span id="dni">—</span></div>
    <div class="field"><b>Titular:</b> <span id="titular">—</span></div>
    <div class="field"><b>Nombre(s):</b> <span id="name">—</span></div>
    <div class="field"><b>Apellido(s):</b> <span id="surname">—</span></div>
    <div class="field"><b>Fecha Nac.:</b> <span id="dob">—</span></div>
    <div class="field"><b>Edad:</b> <span id="age">—</span></div>
    <div class="field"><b>Sexo:</b> <span id="sex">—</span></div>
    <div class="field"><b>Estado civil:</b> <span id="marital">—</span></div>
    <div class="field"><b>Domicilio:</b> <span id="address">—</span></div>
    <div class="field"><b>Ubigeo:</b> <span id="ubigeo">—</span></div>
    <div class="field"><b>Fecha caducidad:</b> <span id="expiry">—</span></div>
  </div>

  <!-- Dependencias desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

  <script>
    // Elementos
    const fileInput = document.getElementById('file');
    const processBtn = document.getElementById('process');
    const clearBtn = document.getElementById('clear');
    const downloadCsvBtn = document.getElementById('downloadCsv');
    const logEl = document.getElementById('log');
    const ocrTextEl = document.getElementById('ocrText');
    const canvas = document.getElementById('pageCanvas');
    const ctx = canvas.getContext('2d');
    const previewImg = document.getElementById('preview');
    const workerStatusEl = document.getElementById('workerStatus');
    const fastModeCheckbox = document.getElementById('fastMode');

    let currentFile = null;
    let ocrWorker = null;
    let workerReady = false;
    let lastExtract = {};

    // Inicializar listener
    fileInput.addEventListener('change', e=>{ currentFile = e.target.files[0]; showPreviewFile(currentFile); log('Archivo listo: ' + (currentFile?currentFile.name:'—')) });

    document.querySelector('label.file').addEventListener('dragover', e=>{ e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
    document.querySelector('label.file').addEventListener('drop', e=>{
      e.preventDefault(); const f = e.dataTransfer.files[0]; fileInput.files = e.dataTransfer.files; currentFile = f; showPreviewFile(currentFile); log('Archivo arrastrado: ' + f.name);
    });

    clearBtn.addEventListener('click', ()=>{ fileInput.value = ''; currentFile = null; resetResults(); previewImg.src=''; log('Limpiado') });

    downloadCsvBtn.addEventListener('click', ()=>{ if(!lastExtract || !lastExtract.dni) return alert('No hay datos para descargar'); downloadCSV(lastExtract) });

    processBtn.addEventListener('click', async ()=>{
      if(!currentFile){ alert('Selecciona un archivo primero'); return }
      resetResults();
      log('Preparando lectura...');

      const fastMode = fastModeCheckbox.checked;

      try{
        // renderizar documento reducido a un tamaño razonable para velocidad
        if(currentFile.type === 'application/pdf' || currentFile.name.toLowerCase().endsWith('.pdf')){
          await renderPdfToCanvas(currentFile, fastMode);
        } else {
          await renderImageToCanvas(currentFile, fastMode);
        }

        // Preprocesar (contraste / brillo) usando canvas filter para mejorar OCR
        preprocessCanvas(canvas);

        // Asegurar worker (cargamos en background si no está listo)
        await ensureWorker();

        log('Ejecutando OCR (esto puede tardar unos segundos)');
        const { data: { text } } = await ocrWorker.recognize(canvas);

        ocrTextEl.textContent = text;
        log('OCR terminado, extrayendo campos...');
        const extracted = extractFields(text);
        lastExtract = extracted;
        displayExtracted(extracted);
        log('Extracción finalizada');

      }catch(err){ console.error(err); log('Error: ' + (err.message||err)); alert('Ocurrió un error. Mira la consola para detalles.') }
    });

    // Worker init (lazy but cached). Carga idioma español; si falla usa inglés.
    async function ensureWorker(){
      if(workerReady && ocrWorker) return;
      workerStatusEl.textContent = 'Cargando...';
      ocrWorker = Tesseract.createWorker({ logger: m => { if(m.status) log(m.status + (m.progress? ' — ' + Math.round(m.progress*100) + '%':'')); } });
      await ocrWorker.load();
      try{ await ocrWorker.loadLanguage('spa'); await ocrWorker.initialize('spa'); }catch(e){ console.warn('No se pudo cargar spa, usando eng', e); await ocrWorker.loadLanguage('eng'); await ocrWorker.initialize('eng'); }
      // optimizaciones: página única, modo simple
      try{ await ocrWorker.setParameters({ tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK }); }catch(e){}
      workerReady = true; workerStatusEl.textContent = 'Listo';
    }

    // Renderizar imagen a canvas con tamaño limitado para velocidad
    async function renderImageToCanvas(file, fastMode){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload = ()=>{
          const maxW = fastMode?900:1200; // modo rápido reduce resolución
          const scale = Math.min(1, maxW / img.width);
          canvas.width = Math.round(img.width * scale);
          canvas.height = Math.round(img.height * scale);
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(img,0,0,canvas.width,canvas.height);
          // actualizar preview con la imagen renderizada (mejor para PDFs también)
          previewImg.src = canvas.toDataURL('image/jpeg',0.9);
          resolve();
        };
        img.onerror = (e)=>reject(e);
        img.src = URL.createObjectURL(file);
      });
    }

    // Renderizar PDF primera página
    async function renderPdfToCanvas(file, fastMode){
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data:arrayBuffer}).promise;
      const page = await pdf.getPage(1);
      // calcular escala según ancho deseado
      const initialViewport = page.getViewport({scale:1});
      const maxW = fastMode?900:1200;
      const scale = Math.min(1.4, maxW / initialViewport.width);
      const viewport = page.getViewport({scale});
      canvas.width = Math.round(viewport.width);
      canvas.height = Math.round(viewport.height);
      // render
      const renderContext = { canvasContext: ctx, viewport };
      await page.render(renderContext).promise;
      previewImg.src = canvas.toDataURL('image/jpeg',0.9);
    }

    function showPreviewFile(file){
      if(!file) return; const url = URL.createObjectURL(file); previewImg.src = url; // si es PDF el preview lo actualizamos luego
    }

    function preprocessCanvas(sourceCanvas){
      // aplicamos un filtro simple de contraste y brillo para mejorar OCR
      try{
        const tmp = document.createElement('canvas');
        tmp.width = sourceCanvas.width; tmp.height = sourceCanvas.height;
        const tctx = tmp.getContext('2d');
        // filtros CSS - funcionan en navegadores modernos
        tctx.filter = 'contrast(130%) brightness(95%)';
        tctx.drawImage(sourceCanvas,0,0);
        // copiar de vuelta
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(tmp,0,0);
      }catch(e){ console.warn('Preprocess falló, continuando sin filtros', e); }
    }

    function resetResults(){
      document.getElementById('dni').textContent='—'; document.getElementById('titular').textContent='—'; document.getElementById('name').textContent='—'; document.getElementById('surname').textContent='—'; document.getElementById('dob').textContent='—'; document.getElementById('age').textContent='—'; document.getElementById('sex').textContent='—'; document.getElementById('marital').textContent='—'; document.getElementById('address').textContent='—'; document.getElementById('ubigeo').textContent='—'; document.getElementById('expiry').textContent='—'; ocrTextEl.textContent='—'; lastExtract = {};
    }

    function log(msg){ logEl.textContent = msg }

    // Extracción robusta basada en etiquetas comunes + heurísticas
    function extractFields(rawText){
      const text = rawText.replace(/\r/g,'');
      const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
      const U = text.toUpperCase();

      const result = {
        dni: '', titular:'', name:'', surname:'', dob:'', age:'', sex:'', marital:'', address:'', ubigeo:'', expiry:''
      };

      // 1) DNI (preferir la línea con palabra DNI)
      let m = U.match(/DNI[^0-9A-Z\n\-:]*([0-9]{6,10})/);
      if(!m){
        // buscar cualquier 8 dígitos en el texto (común en Perú)
        m = U.match(/\b([0-9]{8})\b/);
      }
      if(m) result.dni = m[1] || m[0];

      // 2) TITULAR / NOMBRE(S)
      const titularRx = /TITULAR\s*[:\-]?\s*(.+)/i;
      const nombreRx = /NOMBRE|NOMBRE|NOMBRES\s*[:\-]?\s*(.+)/i; // typo safe
      for(const line of lines){
        if(/TITULAR/i.test(line)){
          const mm = line.match(titularRx); if(mm && mm[1]){ result.titular = mm[1].replace(/\s+\/+\s+/,' ').trim(); continue }
        }
        if(/NOMB/i.test(line) && !result.titular){
          const mm = line.match(/NOMB(?:RE|RES)?\s*[:\-]?\s*(.+)/i); if(mm && mm[1]){ result.titular = mm[1].trim(); continue }
        }
      }

      // If titular still empty, try line before DNI
      if(!result.titular && result.dni){
        const idx = lines.findIndex(l=> new RegExp(result.dni).test(l));
        if(idx>0){
          // buscar arriba hasta 3 líneas previas
          const slice = lines.slice(Math.max(0,idx-3), idx+1);
          for(const s of slice){ if(/[A-ZÁÉÍÓÚÑ]{3,}\s+[A-ZÁÉÍÓÚÑ]{3,}/i.test(s)){ result.titular = s; break } }
        }
      }

      // parse titular into surname/name if possible (format: LAST, FIRST)
      if(result.titular){
        const t = result.titular;
        if(t.includes(',')){
          const parts = t.split(',').map(s=>s.trim()); result.surname = parts[0]; result.name = parts.slice(1).join(', ');
        } else {
          // try split last two words as surname
          const p = t.split(/\s+/);
          if(p.length>=2){ result.name = p.slice(-2).join(' '); result.surname = p.slice(0,-2).join(' ') || p[0]; }
        }
      }

      // 3) Fecha nacimiento
      let dm = text.match(/FECHA\s*NACIM(?:IENTO)?\s*[:\-]?\s*([0-3]?\d[\/\-]\d{1,2}[\/\-]\d{2,4})/i);
      if(!dm) dm = text.match(/(\b[0-3]?\d[\/\-]\d{1,2}[\/\-]\d{2,4}\b)/);
      if(dm) result.dob = dm[1] || dm[0];
      if(result.dob){ const age = computeAgeFromString(result.dob); if(age!==null) result.age = age + ' años'; }

      // 4) Sexo
      const sexm = text.match(/SEXO\s*[:\-]?\s*([A-Z]+)/i);
      if(sexm) result.sex = sexm[1].trim();

      // 5) Estado Civil
      const em = text.match(/ESTADO\s*CIVIL\s*[:\-]?\s*([A-Z]+)/i);
      if(em) result.marital = em[1].trim();

      // 6) Domicilio
      const dom = text.match(/DOMICILIO\s*[:\-]?\s*(.+)/i);
      if(dom) result.address = dom[1].trim();

      // 7) Ubigeo domicilio
      const ub = text.match(/UBIGEO\s*DOMICILIO\s*[:\-]?\s*(.+)/i) || text.match(/UBIGEO\s*[:\-]?\s*(.+)/i);
      if(ub) result.ubigeo = ub[1].trim();

      // 8) Fecha caducidad
      const fx = text.match(/FECHA\s*CADUCID(?:AD|AD\w*)\s*(?:DNI)?\s*[:\-]?\s*([0-3]?\d[\/\-]\d{1,2}[\/\-]\d{2,4})/i) || text.match(/FECHA\s*CADUCIDAD\s*[:\-]?\s*(.+)/i) || text.match(/FECHA\s*CADUCIDAD\s*DNI\s*[:\-]?\s*(.+)/i);
      if(fx) result.expiry = fx[1] ? fx[1].trim() : fx[0];

      // final cleaning: uppercase trim, replace repeating spaces
      for(const k in result){ if(typeof result[k] === 'string') result[k] = (result[k]||'').replace(/\s{2,}/g,' ').trim(); }

      return result;
    }

    function displayExtracted(data){
      document.getElementById('dni').textContent = data.dni || 'No detectado';
      document.getElementById('titular').textContent = data.titular || 'No detectado';
      document.getElementById('name').textContent = data.name || 'No detectado';
      document.getElementById('surname').textContent = data.surname || 'No detectado';
      document.getElementById('dob').textContent = data.dob || 'No detectado';
      document.getElementById('age').textContent = data.age || 'No detectado';
      document.getElementById('sex').textContent = data.sex || 'No detectado';
      document.getElementById('marital').textContent = data.marital || 'No detectado';
      document.getElementById('address').textContent = data.address || 'No detectado';
      document.getElementById('ubigeo').textContent = data.ubigeo || 'No detectado';
      document.getElementById('expiry').textContent = data.expiry || 'No detectado';
    }

    function computeAgeFromString(s){
      if(!s) return null;
      const m1 = s.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})/); // dd/mm/yyyy
      if(m1){ const d = new Date(Number(m1[3]), Number(m1[2])-1, Number(m1[1])); return ageFromDate(d); }
      const m2 = s.match(/(\d{4})[\/\-](\d{2})[\/\-](\d{2})/); // yyyy-mm-dd
      if(m2){ const d = new Date(Number(m2[1]), Number(m2[2])-1, Number(m2[3])); return ageFromDate(d); }
      return null;
    }
    function ageFromDate(d){ if(!d || isNaN(d)) return null; const today = new Date(); let age = today.getFullYear() - d.getFullYear(); const m = today.getMonth() - d.getMonth(); if(m<0 || (m===0 && today.getDate() < d.getDate())) age--; return age; }

    function downloadCSV(obj){
      const keys = ['dni','titular','name','surname','dob','age','sex','marital','address','ubigeo','expiry'];
      const rows = [keys.join(','), keys.map(k=>`"${(obj[k]||'').replace(/"/g,'""')}"`).join(',')];
      const blob = new Blob([rows.join('\n')], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = (obj.dni||'datos') + '.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // inicializar worker de forma perezosa: no lo cargamos automáticamente para no bloquear la carga de la página
    // Se cargará cuando el usuario haga click en "Procesar" por primera vez (ensureWorker()).

  </script>
</body>
</html>